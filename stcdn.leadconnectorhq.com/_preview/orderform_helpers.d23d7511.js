import{B as m,x as H,Y as p}from"./entry.0e8f1b40.js";import{A as D,b as R,C as B}from"./HLConst.96411594.js";import{U as Q,W as V,k as rr,ap as z,al as M,V as Y,w as j,ak as C,a8 as k,u as J,N as er,G as tr,P as ir,Q as ar,R as nr}from"./constants.c1fa6fa6.js";import{F as sr}from"./FunnelServices.e4841ee2.js";import{f as G}from"./funnel_event_helper.495be8ad.js";const Sr={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},yr=(r,e,t)=>{let o=[];return{updatedProducts:r.map(a=>{if(a._id===t._id){if(e>a.max)return a.qty=a.qty,o.push(`A maximum of ${a.max} units of ${a.name} only can be purchased`),a;if(e>a.price.availableQuantity&&a.price.trackInventory&&!a.price.allowOutOfStockPurchases)return a.qty=a.qty,o.push(`Only ${a.price.availableQuantity} units of ${a.name} are in stock`),a;a.qty=e}return a}),errorMessages:o}},wr=r=>{var e,t,o;return((e=r==null?void 0:r.price)==null?void 0:e.availableQuantity)<=0&&((t=r==null?void 0:r.price)==null?void 0:t.trackInventory)&&!((o=r==null?void 0:r.price)!=null&&o.allowOutOfStockPurchases)},vr=(r,e)=>e.find(t=>t._id===r.id),or=async({contactId:r,domain:e,pageUrl:t,locationId:o,productPreviewList:u,isCouponApplied:a,couponCode:i,couponSessionId:n,store:f,subType:c,traceId:h="",reCaptchaToken:s,isEcommercePurchase:w,shippingRateId:l,toZip:b,toState:O,toCountry:P,shippingCarrierRateId:E})=>{var S,v,g,N;try{const I=m("msgsndr_id").value,A=m("am_id").value,W=m("am_fingerprint").value,L=f.funnelName||"funnel";e||(e=window.location.hostname,t=window.location.pathname);const{funnelPageId:T,funnelId:U,stepId:x}=f,F={altId:o,altType:"location",shippingRateId:l,shippingCarrierRateId:E,contactId:r,source:{type:f.pageType===C.FUNNEL?C.FUNNEL:C.WEBSITE,subType:c,id:U,name:L,meta:{stepId:x,pageId:T,domain:e,pageUrl:t,affiliateManager:{id:A,fingerprint:W}}},products:u.map(_=>({id:w?_.selectedPrice._id:_._id,qty:_.qty||_.quantity})),fingerprint:I,trackingId:z(),traceId:h,toZip:b,toState:O,toCountry:P};a&&(F.couponCode=i,F.couponSessionId=n),s&&(F.captchaToken=s);const y=await k.createOrder(F);if(!((S=y.order)==null?void 0:S._id))throw new Error("Something went wrong while creating order. Please try again later.");return y}catch(I){return console.error(I),{error:!0,message:(g=(v=I==null?void 0:I.response)==null?void 0:v._data)==null?void 0:g.message,status:(N=I==null?void 0:I.response)==null?void 0:N.status}}},ur=async(r,e,t,o,u,a)=>{var q,_,$;const i=m("msgsndr_id").value,n=m("am_id").value,f=m("am_fingerprint").value,c=er(r.locationId),h=tr(r.locationId),s=ir(),w=r.funnelName||"funnel";let{domain:l,page_url:b}=e.query;l||(l=window.location.hostname,b=window.location.pathname);const{funnelPageId:O,funnelId:P,stepId:E}=r,S={eventType:"optin",domainName:l,pageUrl:b,funnelId:P,pageId:O,stepId:E},{address:v,country:g,state:N,city:I,zipcode:A,fullName:W,phoneNumber:L,emailId:T,companyName:U}=t,x={addressLine1:v,country:g||o,state:N,city:I,zip:A};s.medium=ar.OrderForm,s.mediumId=S.stepId;const F={lead:!0,eventData:s,source:w,pageId:O,funnelId:P,sessionId:c,funnelEventData:S,sessionFingerprint:h||null},y={locationId:r.locationId,name:W,phone:L,email:(T==null?void 0:T.toLowerCase())||"",companyName:U,address:x,attribution:F,timezone:nr(),amId:String(n),amFingerprint:f,orderFormType:"one_step_form_submission",captchaToken:u};a.enableStickyContact&&(y.attribution.fingerprint=i,y.attribution.funnelEventData.fingerprint=i),a.enableForceCreate&&(y.attribution.forceCreate=!0),a.enableEmailValidation&&(y.attribution.session_d=Number(a.enableEmailValidation)||0);try{const d=await sr.createContact(y);if(!d)throw new Error("Something went wrong. Please try again later.");if(i!==d.fingerprint){r.fingerprint=i;const X=m("msgsndr_id",{path:"/",maxAge:31536e3});X.value=d.fingerprint}z();const K=Y(d);j("_ud",K),H(()=>{G("track","SubmitApplication")});let Z=d.sessionFingerprint;return s&&(Q({sessionId:d.sessionId||null,locationId:r.locationId}),Z&&V(r.locationId,Z)),d}catch(d){return console.error(d),{error:!0,message:(_=(q=d==null?void 0:d.response)==null?void 0:q._data)==null?void 0:_.message,status:($=d==null?void 0:d.response)==null?void 0:$.status}}},_r=async(r,e,t,o,u,a,i,n,f,c,h,s,w,l,b,O,P)=>{var E,S,v;if((!i||!i.id)&&(i=await ur(r,e,t,o,u,a),u=void 0),i!=null&&i.error){let g={};return(i==null?void 0:i.status)===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0},g):(g={error:!0,processingPayment:!1,cardErrorMsg:i.message||"We're sorry, but something went wrong. Please try again"},g)}if((i.id&&!n||!((E=n==null?void 0:n.order)!=null&&E._id))&&(n=await or({contactId:i==null?void 0:i.id,domain:r.domain,pageUrl:r.pageUrl,locationId:r.locationId,productPreviewList:c,isCouponApplied:f,couponCode:s,couponSessionId:h,store:r,subType:l,traceId:i==null?void 0:i.traceId,reCaptchaToken:u,isEcommercePurchase:w,shippingRateId:b,toZip:(t==null?void 0:t.zipcode)??((S=t.address)==null?void 0:S.zip),toState:O,toCountry:(t==null?void 0:t.country)??((v=t.address)==null?void 0:v.country),shippingCarrierRateId:P}),u=void 0),n!=null&&n.error){let g={};return n.status===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:i},g):(g={error:!0,processingPayment:!1,contactResponse:i,cardErrorMsg:n.message||"We're sorry, but something went wrong. Please try again"},g)}return(n==null?void 0:n.success)===!1?{error:!0,cardErrorMsg:n==null?void 0:n.message,processingPayment:!1}:(sessionStorage.setItem("orderResponse",JSON.stringify(n)),l!=M.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(i)),sessionStorage.setItem("orderResponse",JSON.stringify(n)),l!=M.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(i)),sessionStorage.setItem("orderResponse",JSON.stringify(n)),l!=M.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(i)),{contactResponse:i,orderResponse:n,reCaptchaToken:u})},lr=(r,e,t,o)=>{var a;if(z()!=(t==null?void 0:t.verifiedTrackingId)){const i=m("tr",{path:"/",maxAge:900});i.value=t==null?void 0:t.verifiedTrackingId}if(o!==M.TWO_STEP_ORDER_FORM){if(r.fingerprint!==e){const n=m("msgsndr_id",{path:"/",maxAge:31536e3});n.value=r.fingerprint}const i=Y(r);j("_ud",i)}if((a=r==null?void 0:r.attribution_source)!=null&&a.fbEventId){let i=r.attribution_source.fbEventId;H(()=>{G("track","OrderFormPurchase",i)})}else console.warn("Facebook event Id missing from attribution!")},br=async(r,e,t,o,u)=>{let a=!1,i="";if(e!=null&&e.message&&!(e!=null&&e.success))throw new Error(e.message);t===D&&(e!=null&&e.pendingConfirmation)&&(a=!0,i="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const n=m("msgsndr_id").value;await lr(r,n,e,u);const f=m("provider");f.value=t===R?"pp":t===B?B:"cc",await dr({sessionId:r.sessionId,sessionFingerprint:e==null?void 0:e.sessionFingerprint},o);const c=sessionStorage.getItem("redirect");if(gr(o),c){sessionStorage.removeItem("redirect"),window.location.href=c;return}return{paymentResponseData:e,authorizeOrderPendingConfirmation:a,authorizeOrderAlertMsg:i}},dr=(r,e)=>{r&&r.sessionId&&(Q({sessionId:r.sessionId||null,locationId:e}),r.sessionFingerprint&&V(e,r.sessionFingerprint))},Or=r=>{var t;(!(r.keyCode>=48&&r.keyCode<=57||r.keyCode>=96&&r.keyCode<=105)||!/^\d{0,2}$/.test((t=r.target)==null?void 0:t.value))&&r.keyCode!==8&&r.preventDefault()},gr=r=>{const e=rr();return sessionStorage.setItem(`couponSessionId_${r}`,e),e},Pr=async(r,e,t="",o,u,a)=>{var i,n,f,c,h;try{const s=J(),w={altId:s.value.locationId,altType:"location",couponCode:t,source:{type:s.value.pageType===C.FUNNEL?C.FUNNEL:C.WEBSITE,subType:e,id:s.value.funnelId,name:s.value.funnelName,meta:{stepId:s.value.stepId,pageId:s.value.funnelPageId,domain:s.value.domain,pageUrl:s.value.pageUrl,affiliateManager:{id:m("am_id").value,fingerprint:m("msgsndr_id").value}}},products:r,toCountry:o,toState:u,toZip:a},l=await k.getAmountSummary(w);return{total:l.summary.total,subtotal:l.summary.subtotal,taxSummary:l.summary.taxSummary,subtotalWithDiscount:l.summary.subtotalWithDiscount,futureRecurringPaymentAmount:(i=l.recurringSummary)==null?void 0:i.subtotalWithDiscount}}catch(s){return console.error(s),{error:!0,message:((f=(n=s==null?void 0:s.response)==null?void 0:n._data)==null?void 0:f.message)||"Something went wrong while fetching order total. Please try again later",status:(h=(c=s==null?void 0:s.response)==null?void 0:c._data)==null?void 0:h.status}}},Er=async(r,e)=>{const t=await k.getLastPaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e});return{paymentProvider:t==null?void 0:t.paymentProvider,paymentMethod:t==null?void 0:t.paymentMethod}},Fr=async(r,e)=>await k.getLastSquarePaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e}),Cr=(r,e,t,o)=>{const u=e<=0&&!t,a=t&&o<=0,i=u||a;return!!(r&&i||i)},Tr=async()=>{const r=J();try{const e=await k.getStatesInformation();if(e&&e.error)throw p(e.error);r.value.countryList=(e==null?void 0:e.data)??[]}catch(e){console.error("Failed to fetch country list",e)}},kr=r=>J().value.countryList.find(t=>t.code===r),Nr=(r,e,t)=>{if(r.startsWith("+44")&&e.match(/^07\d*$/)){const o=r.replace("+44 1534","+44").replace("1534","");return window.libphonenumber.parsePhoneNumberFromString(o,"JE").formatInternational()}return t.formatInternational()};export{kr as a,Fr as b,or as c,Pr as d,Nr as e,Er as f,Tr as g,br as h,gr as i,wr as j,vr as k,yr as l,_r as m,Or as n,Cr as p,Sr as s};
